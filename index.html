<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <title>Tachistoscopio</title>
    
    <!-- Manifest e icone per PWA -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlRhY2hpc3Rvc2NvcGlvIiwKICAic2hvcnRfbmFtZSI6ICJUYWNoaXN0b3Njb3BpbyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzRmNDZlNSIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0LXByaW1hcnkiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3ZpYS5wbGFjZWhvbGRlci5jb20vMTkyIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9LAogICAgewogICAgICAic3JjIjogImh0dHBzOi8vdmlhLnBsYWNlaG9sZGVyLmNvbS81MTIiLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
    <link rel="icon" href="https://via.placeholder.com/48">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/180">
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React e ReactDOM via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel per JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }
        #root {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        input, button, select {
            font-size: 16px; /* Previene lo zoom su iOS */
        }
        /* Per nascondere la barra degli strumenti in modalità standalone */
        @media all and (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Il codice del componente React
        
        const TachistoscopioApp = () => {
          // Stati per gestire l'applicazione
          const [difficulty, setDifficulty] = React.useState('facile');
          const [syllableCount, setSyllableCount] = React.useState(1);
          const [displayTime, setDisplayTime] = React.useState(500); // in millisecondi
          const [isRunning, setIsRunning] = React.useState(false);
          const [currentWord, setCurrentWord] = React.useState('');
          const [userInput, setUserInput] = React.useState('');
          const [score, setScore] = React.useState(0);
          const [totalAttempts, setTotalAttempts] = React.useState(0);
          const [history, setHistory] = React.useState([]);
          const [showAnswer, setShowAnswer] = React.useState(false);
          const [sessionActive, setSessionActive] = React.useState(false);
          const [sessionWords, setSessionWords] = React.useState([]);
          const [currentWordIndex, setCurrentWordIndex] = React.useState(0);
          const [showAddWordModal, setShowAddWordModal] = React.useState(false);
          const [newWord, setNewWord] = React.useState('');
          const [newWordSyllables, setNewWordSyllables] = React.useState(1);
          const [isFullscreen, setIsFullscreen] = React.useState(false);

          // Parole italiane organizzate per numero di sillabe
          const [wordsBySyllables, setWordsBySyllables] = React.useState({
            1: ['tu', 'qui', 'sa', 'me', 'te', 'no', 'sì', 'blu', 'giù', 'tre', 'due'],
            2: ['casa', 'sole', 'vino', 'mare', 'pane', 'mela', 'cane', 'gatto', 'libro', 'sedia', 'testa', 'piede', 'mano', 'luce', 'nero', 'rosso', 'verde', 'moto', 'lento', 'bello'],
            3: ['tavolo', 'pagina', 'finestra', 'balcone', 'lamiera', 'corrente', 'farmacia', 'bottega', 'mattino', 'nuvola', 'pensare', 'cadere', 'vicino', 'parola', 'tecnico', 'metodo', 'leggere'],
            4: ['bicicletta', 'automobile', 'televisione', 'meccanico', 'ristorante', 'biblioteca', 'geografia', 'matematica', 'università', 'abilità', 'occupazione', 'animazione', 'decorazione'],
            5: ['collaborazione', 'responsabilità', 'comunicazione', 'determinazione', 'illuminazione', 'accelerazione', 'protagonista', 'educazione', 'argomentazione', 'alimentazione'],
            6: ['rappresentazione', 'interdisciplinare', 'internazionale', 'audiovisivo', 'meteorologia', 'individualità', 'universitario', 'multiculturale', 'identificazione']
          });

          // Configurazione delle difficoltà
          const difficultySettings = {
            facile: { minSyllables: 1, maxSyllables: 2, minTime: 500, maxTime: 1000 },
            medio: { minSyllables: 2, maxSyllables: 4, minTime: 300, maxTime: 700 },
            difficile: { minSyllables: 3, maxSyllables: 6, minTime: 100, maxTime: 500 }
          };

          // Verifica se il browser supporta la modalità fullscreen
          const supportsFullscreen = document.documentElement.requestFullscreen || 
                                     document.documentElement.webkitRequestFullscreen || 
                                     document.documentElement.mozRequestFullScreen ||
                                     document.documentElement.msRequestFullscreen;

          // Controlla cambiamenti nello stato di fullscreen
          React.useEffect(() => {
            const handleFullscreenChange = () => {
              setIsFullscreen(!!document.fullscreenElement);
            };
            
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);
            
            return () => {
              document.removeEventListener('fullscreenchange', handleFullscreenChange);
              document.removeEventListener('webkitfullscreenchange', handleFullscreenChange);
              document.removeEventListener('mozfullscreenchange', handleFullscreenChange);
              document.removeEventListener('MSFullscreenChange', handleFullscreenChange);
            };
          }, []);

          // Aggiorna le impostazioni in base alla difficoltà selezionata
          React.useEffect(() => {
            const settings = difficultySettings[difficulty];
            setSyllableCount(prev => Math.min(Math.max(prev, settings.minSyllables), settings.maxSyllables));
            setDisplayTime(prev => Math.min(Math.max(prev, settings.minTime), settings.maxTime));
          }, [difficulty]);

          // Carica le parole dal localStorage all'avvio
          React.useEffect(() => {
            const savedWords = localStorage.getItem('tachistoscopio_words');
            if (savedWords) {
              try {
                const parsed = JSON.parse(savedWords);
                if (parsed && typeof parsed === 'object') {
                  setWordsBySyllables(parsed);
                }
              } catch (e) {
                console.error("Errore nel caricamento delle parole salvate:", e);
              }
            }
          }, []);

          // Seleziona parole per la sessione
          const selectSessionWords = () => {
            const availableWords = wordsBySyllables[syllableCount] || [];
            if (availableWords.length === 0) {
              alert('Nessuna parola disponibile per questo numero di sillabe');
              return false;
            }
            
            // Seleziona 10 parole casuali (o meno se non ce ne sono abbastanza)
            const wordCount = Math.min(10, availableWords.length);
            const selectedWords = [];
            const indices = new Set();
            
            while (indices.size < wordCount) {
              const idx = Math.floor(Math.random() * availableWords.length);
              if (!indices.has(idx)) {
                indices.add(idx);
                selectedWords.push(availableWords[idx]);
              }
            }
            
            setSessionWords(selectedWords);
            setCurrentWordIndex(0);
            return true;
          };

          // Avvia una nuova sessione di esercizio
          const startSession = () => {
            if (selectSessionWords()) {
              setSessionActive(true);
              setScore(0);
              setTotalAttempts(0);
              setHistory([]);
              setCurrentWordIndex(0);
              showNextWord();
            }
          };

          // Mostra la prossima parola
          const showNextWord = () => {
            if (currentWordIndex >= sessionWords.length) {
              endSession();
              return;
            }
            
            setCurrentWord(sessionWords[currentWordIndex]);
            setUserInput('');
            setShowAnswer(false);
            setIsRunning(true);
            
            // Mostra la parola per il tempo impostato, poi la nasconde
            setTimeout(() => {
              setIsRunning(false);
            }, displayTime);
          };

          // Verifica la risposta dell'utente
          const checkAnswer = () => {
            const correct = userInput.toLowerCase().trim() === currentWord.toLowerCase();
            const newHistory = [...history, {
              word: currentWord,
              input: userInput,
              correct: correct
            }];
            
            setHistory(newHistory);
            setTotalAttempts(totalAttempts + 1);
            if (correct) setScore(score + 1);
            
            setCurrentWordIndex(currentWordIndex + 1);
            
            // Mostra la risposta corretta
            setShowAnswer(true);
            
            // Passa alla prossima parola dopo un breve ritardo
            setTimeout(() => {
              showNextWord();
            }, 1500);
          };

          // Termina la sessione
          const endSession = () => {
            setSessionActive(false);
            alert(`Sessione completata!\nPunteggio: ${score}/${totalAttempts}\nPercentuale: ${totalAttempts > 0 ? Math.round((score / totalAttempts) * 100) : 0}%`);
          };

          // Funzione per aggiungere una nuova parola
          const addNewWord = () => {
            if (newWord.trim() === '') {
              alert('Per favore, inserisci una parola');
              return;
            }

            // Aggiungi la parola al numero di sillabe selezionato
            setWordsBySyllables(prev => {
              const updatedWords = { ...prev };
              if (!updatedWords[newWordSyllables]) {
                updatedWords[newWordSyllables] = [];
              }
              updatedWords[newWordSyllables] = [...updatedWords[newWordSyllables], newWord.trim().toLowerCase()];
              
              // Salva nel localStorage
              try {
                localStorage.setItem('tachistoscopio_words', JSON.stringify(updatedWords));
              } catch (e) {
                console.error("Errore nel salvataggio delle parole:", e);
              }
              
              return updatedWords;
            });

            // Resetta i campi e chiudi il modal
            setNewWord('');
            setShowAddWordModal(false);
            alert(`Parola "${newWord}" aggiunta con successo al gruppo di ${newWordSyllables} sillabe!`);
          };

          // Esporta le parole in formato JSON
          const exportWords = () => {
            try {
              const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(wordsBySyllables));
              const downloadAnchorNode = document.createElement('a');
              downloadAnchorNode.setAttribute("href", dataStr);
              downloadAnchorNode.setAttribute("download", "tachistoscopio_parole.json");
              document.body.appendChild(downloadAnchorNode);
              downloadAnchorNode.click();
              downloadAnchorNode.remove();
            } catch (e) {
              alert("Errore nell'esportazione delle parole: " + e.message);
            }
          };

          // Importa le parole da un file JSON
          const importWords = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const importedWords = JSON.parse(e.target.result);
                if (importedWords && typeof importedWords === 'object') {
                  setWordsBySyllables(importedWords);
                  
                  // Salva nel localStorage
                  localStorage.setItem('tachistoscopio_words', JSON.stringify(importedWords));
                  
                  alert('Parole importate con successo!');
                } else {
                  throw new Error("Formato file non valido");
                }
              } catch (error) {
                alert('Errore durante l\'importazione: ' + error.message);
              }
            };
            reader.readAsText(file);
          };

          // Abilita/disabilita la modalità a schermo intero
          const toggleFullscreen = () => {
            if (!document.fullscreenElement) {
              const docEl = document.documentElement;
              
              const requestFullScreen = docEl.requestFullscreen || 
                                        docEl.webkitRequestFullscreen || 
                                        docEl.mozRequestFullScreen || 
                                        docEl.msRequestFullscreen;
                
              if (requestFullScreen) {
                requestFullScreen.call(docEl).catch(err => {
                  console.error(`Errore nella modalità a schermo intero: ${err.message}`);
                });
              }
            } else {
              const exitFullscreen = document.exitFullscreen || 
                                     document.webkitExitFullscreen || 
                                     document.mozCancelFullScreen || 
                                     document.msExitFullscreen;
                                     
              if (exitFullscreen) {
                exitFullscreen.call(document);
              }
            }
          };

          return (
            <div className="p-4 max-w-lg mx-auto bg-white rounded-lg shadow-lg h-full overflow-auto">
              <div className="flex justify-between items-center mb-4">
                <h1 className="text-xl font-bold">Lettura Tachistoscopica</h1>
                {supportsFullscreen && (
                  <button 
                    className="bg-blue-500 text-white p-2 rounded-full"
                    onClick={toggleFullscreen}
                    aria-label={isFullscreen ? "Esci da schermo intero" : "Schermo intero"}
                  >
                    {isFullscreen ? (
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>
                      </svg>
                    ) : (
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                      </svg>
                    )}
                  </button>
                )}
              </div>
              
              {!sessionActive ? (
                <div className="setup-panel space-y-4">
                  <div className="mb-4">
                    <label className="block text-gray-700 mb-2">Livello di difficoltà:</label>
                    <select 
                      className="w-full p-2 border rounded"
                      value={difficulty}
                      onChange={(e) => setDifficulty(e.target.value)}
                    >
                      <option value="facile">Facile</option>
                      <option value="medio">Medio</option>
                      <option value="difficile">Difficile</option>
                    </select>
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-gray-700 mb-2">Numero di sillabe:</label>
                    <input 
                      type="range" 
                      min={difficultySettings[difficulty].minSyllables} 
                      max={difficultySettings[difficulty].maxSyllables}
                      value={syllableCount}
                      onChange={(e) => setSyllableCount(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span>{difficultySettings[difficulty].minSyllables}</span>
                      <span>{syllableCount}</span>
                      <span>{difficultySettings[difficulty].maxSyllables}</span>
                    </div>
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-gray-700 mb-2">Tempo di visualizzazione (ms):</label>
                    <input 
                      type="range" 
                      min={difficultySettings[difficulty].minTime} 
                      max={difficultySettings[difficulty].maxTime}
                      value={displayTime}
                      onChange={(e) => setDisplayTime(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span>{difficultySettings[difficulty].minTime}</span>
                      <span>{displayTime}</span>
                      <span>{difficultySettings[difficulty].maxTime}</span>
                    </div>
                  </div>
                  
                  <div className="flex flex-col sm:flex-row gap-2 mb-4">
                    <button 
                      className="flex-1 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition text-sm"
                      onClick={startSession}
                    >
                      Inizia Esercizio
                    </button>
                    <button 
                      className="flex-1 bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition text-sm"
                      onClick={() => setShowAddWordModal(true)}
                    >
                      Aggiungi Parole
                    </button>
                  </div>
                  
                  <div className="flex flex-col sm:flex-row gap-2">
                    <button 
                      className="flex-1 bg-purple-500 text-white py-2 px-4 rounded hover:bg-purple-600 transition text-sm"
                      onClick={exportWords}
                    >
                      Esporta Parole
                    </button>
                    <label className="flex-1 bg-orange-500 text-white py-2 px-4 rounded hover:bg-orange-600 transition text-center cursor-pointer text-sm">
                      Importa Parole
                      <input 
                        type="file" 
                        accept=".json" 
                        className="hidden" 
                        onChange={importWords}
                      />
                    </label>
                  </div>
                  
                  <div className="mt-4">
                    <h3 className="font-bold mb-2">Parole disponibili per {syllableCount} sillabe:</h3>
                    <div className="border rounded p-2 max-h-24 overflow-y-auto">
                      {wordsBySyllables[syllableCount] && wordsBySyllables[syllableCount].length > 0 ? (
                        <p>{wordsBySyllables[syllableCount].join(', ')}</p>
                      ) : (
                        <p className="text-gray-500">Nessuna parola disponibile per questo numero di sillabe</p>
                      )}
                    </div>
                  </div>
                </div>
              ) : (
                <div className="exercise-panel">
                  <div className="mb-6">
                    <div className="flex justify-between mb-2">
                      <span>Parola: {currentWordIndex + 1}/{sessionWords.length}</span>
                      <span>Punteggio: {score}/{totalAttempts}</span>
                    </div>
                    
                    <div className="h-32 flex items-center justify-center border rounded mb-4">
                      {isRunning ? (
                        <div className="text-3xl font-bold">{currentWord}</div>
                      ) : showAnswer ? (
                        <div className="text-xl">
                          <span className="font-bold">Parola: </span>
                          <span className="text-blue-600">{currentWord}</span>
                          <br />
                          <span className="font-bold">La tua risposta: </span>
                          <span className={history[history.length-1]?.correct ? "text-green-600" : "text-red-600"}>
                            {userInput}
                          </span>
                        </div>
                      ) : (
                        <div className="text-gray-500">La parola è stata mostrata</div>
                      )}
                    </div>
                    
                    {!isRunning && !showAnswer && (
                      <div className="mb-4">
                        <label className="block text-gray-700 mb-2">Cosa hai visto?</label>
                        <div className="flex">
                          <input 
                            type="text" 
                            className="flex-grow p-2 border rounded-l"
                            value={userInput}
                            onChange={(e) => setUserInput(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && checkAnswer()}
                            autoFocus
                          />
                          <button 
                            className="bg-green-500 text-white py-2 px-4 rounded-r hover:bg-green-600 transition"
                            onClick={checkAnswer}
                          >
                            Controlla
                          </button>
                        </div>
                      </div>
                    )}
                    
                    <div className="mt-4">
                      <h3 className="font-bold mb-2">Storico:</h3>
                      <div className="max-h-32 overflow-y-auto border rounded p-2">
                        {history.map((item, index) => (
                          <div key={index} className={`${item.correct ? "text-green-600" : "text-red-600"} mb-1`}>
                            Parola: <span className="font-medium">{item.word}</span> - 
                            Risposta: <span className="font-medium">{item.input}</span>
                          </div>
                        ))}
                        {history.length === 0 && (
                          <div className="text-gray-500">Nessun tentativo ancora registrato</div>
                        )}
                      </div>
                    </div>
                    
                    <button 
                      className="w-full mt-4 bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 transition"
                      onClick={endSession}
                    >
                      Termina Sessione
                    </button>
                  </div>
                </div>
              )}
              
              <div className="mt-4 pt-4 border-t text-sm text-gray-600">
                <p><strong>Istruzioni:</strong> Questo programma ti aiuterà a migliorare la tua capacità di lettura rapida. Seleziona il livello di difficoltà, il numero di sillabe e il tempo di visualizzazione, quindi inizia l'esercizio.</p>
                <p className="mt-2"><strong>Modalità a schermo intero:</strong> Usa il pulsante in alto a destra per entrare in modalità a schermo intero e avere un'esperienza ottimale senza distrazioni.</p>
              </div>
              
              {/* Modal per aggiungere nuove parole */}
              {showAddWordModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg p-6 max-w-sm w-full">
                    <h3 className="text-xl font-bold mb-4">Aggiungi Nuova Parola</h3>
                    
                    <div className="mb-4">
                      <label className="block text-gray-700 mb-2">Parola:</label>
                      <input 
                        type="text" 
                        className="w-full p-2 border rounded"
                        value={newWord}
                        onChange={(e) => setNewWord(e.target.value)}
                        placeholder="Inserisci una parola"
                      />
                    </div>
                    
                    <div className="mb-4">
                      <label className="block text-gray-700 mb-2">Numero di sillabe:</label>
                      <input 
                        type="number" 
                        min="1" 
                        max="10"
                        className="w-full p-2 border rounded"
                        value={newWordSyllables}
                        onChange={(e) => setNewWordSyllables(parseInt(e.target.value))}
                      />
                    </div>
                    
                    <div className="flex justify-end space-x-2">
                      <button 
                        className="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400 transition"
                        onClick={() => setShowAddWordModal(false)}
                      >
                        Annulla
                      </button>
                      <button 
                        className="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition"
                        onClick={addNewWord}
                      >
                        Aggiungi
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        // Rendering dell'applicazione
        const domContainer = document.getElementById('root');
        const root = ReactDOM.createRoot(domContainer);
        root.render(<TachistoscopioApp />);
    </script>

    <!-- Service Worker Registration -->
    <script>
      // Codice inline del service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(
          URL.createObjectURL(
            new Blob(
              [`
                const CACHE_NAME = 'tachistoscopio-v1';
                
                self.addEventListener('install', event => {
                  self.skipWaiting();
                });
                
                self.addEventListener('activate', event => {
                  event.waitUntil(self.clients.claim());
                });
                
                self.addEventListener('fetch', event => {
                  event.respondWith(
                    fetch(event.request)
                      .catch(() => {
                        return new Response('Sei offline. Ricarica la pagina quando torni online.');
                      })
                  );
                });
              `],
              { type: 'text/javascript' }
            )
          )
        )
        .then(() => console.log('Service Worker registrato con successo'))
        .catch(error => console.error('Errore registrazione Service Worker:', error));
      }
    </script>
</body>
</html>
